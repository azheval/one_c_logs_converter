# Руководство пользователя

Настройка и запуск приложение для конвертации логов 1С и тестовый стенд для их визуализации.

## 1. Настройка приложения (`config.json`)

Основной файл конфигурации приложения - `config.json`. Он позволяет указать, за какими каталогами следить и как обрабатывать файлы.

**Важное замечание о путях:** Все пути в файле конфигурации (`app_log_dir`, `output_dir`, и `path` в `log_dirs`) могут быть как абсолютными, так и относительными. **Относительные пути всегда вычисляются от местоположения самого файла `config.json`**, а не от каталога, из которого вы запускаете приложение.

### Структура файла

```json
{
  "log_level": "info",
  "app_log_dir": "/logs",
  "output_dir": "/demo/promtail_logs",
  "projects": [
    {
      "name": "project_a",
      "delete_processed": false,
      "log_dirs": [
        {
          "path": "/demo/project_a",
          "enabled": true
        }
      ]
    },
    {
      "name": "project_b",
      "delete_processed": true,
      "log_dirs": [
        {
          "path": "/demo/project_b",
          "enabled": true
        }
      ]
    }
  ]
}
```

### Описание ключей

- **`log_level`** (строка): Уровень детализации логов самого приложения. Возможные значения: `"debug"`, `"info"`, `"warn"`, `"error"`.
- **`app_log_dir`** (строка): Путь к каталогу, куда приложение будет сохранять свои собственные лог-файлы (например, `/logs`).
- **`output_dir`** (строка): Путь к каталогу, куда будут сохраняться сконвертированные `.json` файлы логов 1С. Promtail будет следить за этой директорией.

- **`projects`** (массив): Список проектов для мониторинга.
    - **`name`** (строка): Уникальное имя проекта. Используется для именования выходного `.json` файла (например, `project_a.json`).
    - **`delete_processed`** (булево): Определяет, нужно ли удалять обработанные файлы.
        - `true`: После успешной конвертации исходный `.xml` файл будет переименован в `.xml.bak` и затем удален.
        - `false`: Файл будет только переименован в `.xml.bak`.
    - **`log_dirs`** (массив): Список каталогов с логами для данного проекта.
        - **`path`** (строка): Путь к каталогу с `.xml` файлами логов 1С.
        - **`enabled`** (булево): Включает (`true`) или отключает (`false`) мониторинг данного каталога.

## 2. Запуск тестового стенда (Docker)

Тестовый стенд состоит из Loki, Grafana и Promtail, которые запускаются с помощью Docker Compose.

### Инструкция по запуску

1.  **Перейдите в каталог `deployment`**:
    ```bash
    cd deployment
    ```

2.  **Запустите Docker Compose**:
    Выполните команду, чтобы собрать и запустить все сервисы в фоновом режиме.
    ```bash
    docker-compose up -d
    ```

3.  **Проверка статуса**:
    Убедитесь, что все три контейнера (loki, promtail, grafana) запущены и работают.
    ```bash
    docker-compose ps
    ```

### Доступ к сервисам

- **Grafana**: Откройте в браузере `http://localhost:3000`. Здесь вы можете создавать дашборды для просмотра логов.
    - Источник данных Loki уже должен быть настроен.
    - Для входа используйте стандартные учетные данные Grafana (`admin`/`admin`), если вы не меняли их.
- **Loki**: Доступен для Grafana и Promtail внутри Docker-сети по адресу `http://loki:3100`.

**Примечание:** Конфигурация Promtail включает в себя мониторинг двух типов логов, которые различаются по меткам (labels):
1.  **Логи 1С**: Сконвертированные `.json` файлы. У них есть две важные метки:
    - `job: "1c_logs"`
    - `project: "имя_проекта"` (например, `"project_a"`). Эта метка создается автоматически из имени файла.
2.  **Логи приложения**: Собственные логи конвертера с меткой `job: "converter_logs"`.

Вы можете использовать эти метки в Grafana для точной фильтрации логов. Например:
- `{project="project_a"}` — показать все логи 1С только для `project_a`.
- `{job="1c_logs", project!="project_a"}` — показать логи 1С всех проектов, кроме `project_a`.
- `{job="converter_logs"}` — показать только логи самого приложения-конвертера.

### Остановка стенда

Чтобы остановить все запущенные контейнеры, выполните команду в каталоге `deployment`:

```bash
docker-compose down
```
